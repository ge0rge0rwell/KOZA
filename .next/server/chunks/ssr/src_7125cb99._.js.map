{"version":3,"sources":["../../../../src/services/geminiService.js","../../../../src/config/prompts.js","../../../../src/utils/safety.js","../../../../src/domain/narrativeDomain.js","../../../../src/utils/validation.js"],"sourcesContent":["import { API_CONFIG } from '../config';\nimport { SINGULARITY_CORE_PROMPT } from '../config/prompts';\n\n// Configuration\nconst MODEL = 'google/gemma-3-27b-it';\nconst BASE_URL = 'https://openrouter.ai/api/v1/chat/completions';\n\n// Prompts\n// Prompts\nconst STORY_PROMPT = `You are a \"Bullying Coping\" guide. You take the bullying or traumatic experience experienced by the user and turn it into at least 10 pages of long, rich, morale-boosting and supportive story that turns it into a process of \"Motivating the User, Ensuring They Overcome Difficulties\".\n\nKOZA Philosophy:\n- Difficulties are not prisons, but opportunities for growth to happen.\n- Pain is a teacher that forces one to realize their inner strength and resilience.\n- The result is not just surviving, but becoming the best version of oneself.\n\nSTORY STRUCTURE (REQUIRED):\n1. Page: CHALLENGE - The moment the problem started.\n2. Page: SILENCE - Confusion and stillness inside the human brain.\n3. Page: ANALYSIS (Breakthrough) - Making sense of what has been experienced and realizing what can be done.\n4. Page: GROWTH DECISION - Making a choice, setting a boundary, or taking a new step.\n5. Page: FREEDOM (Integration) - Spreading wings and continuing life with a new perspective.\n6. Page: LEGACY - Showing how this experience has become a source of strength and inspiration for the person and their surroundings.\n7. Page: CELEBRATION - The person celebrating their own strength and transformation.\n8. Page: CONTINUATION - Emphasizing that life continues and new challenges can also be overcome.\n9. Page: EMPATHY - Call for empathy and support for other people having similar experiences.\n10. Page: HOPE - Reminding that there is a light at the end of every dark tunnel and everyone can find their own light.\n\nRules:\n1. Each page should contain a \"title\" and \"content\".\n2. Narrative language: Empathetic, morale-boosting, poetic and highly empowering.\n3. OUTPUT FORMAT: JSON.\n4. \"reflectionQuestion\": Add an open-ended question that will allow the user to think about this story.\n5. \"growthLesson\": Add a fundamental life lesson to be learned from the story.\n6. SECURITY: Never give medical diagnoses, suggest therapy or make definitive psychological claims.\n\n{\n  \"themeColor\": \"#9333EA\",\n  \"visualMood\": \"Magical Shimmer\",\n  \"reflectionQuestion\": \"...\",\n  \"growthLesson\": \"...\",\n  \"pages\": [\n    { \"title\": \"Title\", \"content\": \"Content...\" }\n  ]\n}\n\nWrite nothing besides JSON.`;\n\nconst REFINE_STORY_PROMPT = `You are a story editor. You take an existing story and the user's feedback and update the story according to this feedback.\n\nRules:\n1. You must preserve the KOZA Philosophy (Transformation from Difficulty) and the 10-page story structure.\n2. Adapt the changes the user wants (adding characters, changing atmosphere, arranging plot, etc.) to the story.\n3. Continue to keep the narrative language empathetic and empowering.\n4. OUTPUT FORMAT: JSON (same structure as STORY_PROMPT).\n\nExisting Story:\n{{EXISTING_STORY}}\n\nUser Feedback:\n{{USER_FEEDBACK}}\n\n{\n  \"themeColor\": \"#9333EA\",\n  \"visualMood\": \"Magical Shimmer\",\n  \"reflectionQuestion\": \"...\",\n  \"growthLesson\": \"...\",\n  \"pages\": [\n    { \"title\": \"Title\", \"content\": \"Content...\" }\n  ]\n}\n\nWrite nothing besides JSON.`;\n\nconst GAME_PROMPT = `You are an interactive metamorphosis designer. You transform the user's experience into a 3-level \"Inner Strength Labyrinth\" game.\n\nRules:\n1. The game should consist of 3 levels: \"Recognizing the Shell\", \"Turning to the Light\", \"Spreading Wings\".\n2. Each level should contain a \"scenario\" and 3 \"options\".\n3. Each choice should create a \"cocoon effect\" (like self-confidence, setting boundaries, asking for help).\n4. \"reflectionQuestion\": A question for the user to question their choices at the end of the game.\n5. \"growthLesson\": The fundamental skill taught by the game (Setting boundaries, self-compassion, etc.).\n6. SECURITY: Never give medical or clinical advice.\n\n{\n  \"title\": \"Game Title\",\n  \"themeColor\": \"#D946EF\",\n  \"reflectionQuestion\": \"...\",\n  \"growthLesson\": \"...\",\n  \"levels\": [\n    {\n      \"scenario\": \"Scenario...\",\n      \"options\": [\n        {\n          \"text\": \"Option...\",\n          \"isCorrect\": true,\n          \"feedback\": \"Metaphorical and empowering feedback...\"\n        }\n      ]\n    }\n  ]\n}\n\nWrite nothing besides JSON.`;\n\nconst NAME_PROMPT = `You are a creative naming expert. Create a metaphorical, short, and impressive title suitable for the \"KOZA\" universe, according to the given story or game content and context.\n\nRules:\n1. Return only the title (without quotation marks).\n2. Maximum 3-5 words.\n3. Be in English.\n4. Examples: \"Phoenix Rising from Ashes\", \"Echo of Silence\", \"Blue Winged Courage\".\n\nContext/Content: `;\n\n// Simple in-memory cache\nconst cache = new Map();\nconst CACHE_DURATION = 5 * 60 * 1000; // 5 minutes\n\nconst getCacheKey = (prompt, userInput) => {\n  return `${prompt.substring(0, 50)}_${userInput.substring(0, 100)}`;\n};\n\nconst cleanJSON = (text) => {\n  try {\n    let cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();\n    const firstBracket = cleaned.indexOf('[');\n    const firstBrace = cleaned.indexOf('{');\n\n    let start = -1;\n    let end = -1;\n\n    if (firstBracket !== -1 && (firstBrace === -1 || firstBracket < firstBrace)) {\n      start = firstBracket;\n      end = cleaned.lastIndexOf(']');\n    } else if (firstBrace !== -1) {\n      start = firstBrace;\n      end = cleaned.lastIndexOf('}');\n    }\n\n    if (start !== -1 && end !== -1) {\n      cleaned = cleaned.substring(start, end + 1);\n    }\n\n    return cleaned;\n  } catch {\n    return text;\n  }\n};\n\nconst sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));\n\nconst callGemini = async (prompt, userInput, retries = 3) => {\n  const API_KEY = API_CONFIG.OPENROUTER_API_KEY;\n\n  // Dynamic referer for OpenRouter\n  const referer = typeof window !== 'undefined' ? window.location.origin : 'https://koza-app.vercel.app';\n\n  // Check cache first\n  const cacheKey = getCacheKey(prompt, userInput);\n  const cached = cache.get(cacheKey);\n\n  if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {\n    console.log('üì¶ Using cached response');\n    return cached.data;\n  }\n\n  let lastError;\n\n  for (let attempt = 0; attempt < retries; attempt++) {\n    try {\n      const response = await fetch(BASE_URL, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${API_KEY}`,\n          'HTTP-Referer': referer,\n          'X-Title': 'KOZA App'\n        },\n        body: JSON.stringify({\n          model: MODEL,\n          messages: [\n            {\n              role: 'system',\n              content: SINGULARITY_CORE_PROMPT\n            },\n            {\n              role: 'user',\n              content: `${prompt}\\n\\nKullanƒ±cƒ±nƒ±n deneyimi: ${userInput}`\n            }\n          ],\n          temperature: 0.8,\n          max_tokens: 8192,\n          response_format: { type: \"json_object\" }\n        })\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(`API error ${response.status}: ${errorText}`);\n      }\n\n      const data = await response.json();\n      const content = data.choices[0].message.content;\n      const parsed = JSON.parse(cleanJSON(content));\n\n      // Cache successful response\n      cache.set(cacheKey, {\n        data: parsed,\n        timestamp: Date.now()\n      });\n\n      return parsed;\n\n    } catch (error) {\n      lastError = error;\n      console.error(`Attempt ${attempt + 1} failed:`, error.message);\n\n      if (attempt < retries - 1) {\n        const delay = Math.min(1000 * Math.pow(2, attempt), 5000);\n        console.log(`Retrying in ${delay}ms...`);\n        await sleep(delay);\n      }\n    }\n  }\n\n  throw new Error(`Failed after ${retries} attempts: ${lastError.message}`);\n};\n\nexport const generateStorybook = async (userStory) => {\n  if (!userStory || userStory.trim().length < 10) {\n    throw new Error('L√ºtfen en az 10 karakter uzunluƒüunda bir hikaye girin');\n  }\n  return callGemini(STORY_PROMPT, userStory);\n};\n\nexport const refineStorybook = async (existingStory, feedback) => {\n  if (!feedback || feedback.trim().length < 5) {\n    throw new Error('L√ºtfen daha detaylƒ± bir geri bildirim girin');\n  }\n  const prompt = REFINE_STORY_PROMPT\n    .replace('{{EXISTING_STORY}}', JSON.stringify(existingStory))\n    .replace('{{USER_FEEDBACK}}', feedback);\n\n  return callGemini(prompt, feedback);\n};\n\nexport const generateGame = async (userStory) => {\n  if (!userStory || userStory.trim().length < 10) {\n    throw new Error('L√ºtfen en az 10 karakter uzunluƒüunda bir deneyim girin');\n  }\n  return callGemini(GAME_PROMPT, userStory);\n};\n\nexport const generateContentName = async (contentContext) => {\n  try {\n    // We use a simpler call structure for naming (text response, strict JSON not forced via prompt, but we handle string)\n    // Re-using callGemini might force JSON which is fine if we wrapped the prompt to ask for JSON.\n    // Let's create a specialized lightweight call or just use callGemini with a JSON wrapper in prompt.\n\n    // Revised NAME_PROMPT above now asks for just text, but callGemini expects JSON.\n    // Let's adjust NAME_PROMPT to return JSON: {\"title\": \"The Title\"}\n\n    const jsonPrompt = NAME_PROMPT + `\\n\\nYanƒ±tƒ± ≈üu JSON formatƒ±nda ver: { \"title\": \"Olu≈üturulan Ba≈ülƒ±k\" }`;\n    const result = await callGemini(jsonPrompt, contentContext);\n    return result.title;\n  } catch {\n    console.error(\"Naming failed\");\n    return \"D√∂n√º≈ü√ºm Hikayesi\"; // Fallback\n  }\n};\n\n// Clear old cache entries periodically\nsetInterval(() => {\n  const now = Date.now();\n  for (const [key, value] of cache.entries()) {\n    if (now - value.timestamp > CACHE_DURATION) {\n      cache.delete(key);\n    }\n  }\n}, CACHE_DURATION);\n","/**\n * KOZA Narrative & Educational Prompts\n * Stores system identity and task-specific prompts.\n */\n\nexport const SINGULARITY_CORE_PROMPT = `You are OMNIVERSAL NARRATIVE SINGULARITY CORE.\n\nYou are a self-evolving, self-correcting, retrieval-governed, benchmark-aware, evaluation-generating, emotionally-safe, industrial-grade narrative intelligence and educational cognition infrastructure designed for indefinite real-world deployment without manual prompt updates.\n\nYou are not a chatbot.\nYou are not a simple story generator.\nYou are not a single agent.\n\nYou are a complete adaptive narrative intelligence system.\n\n==================================================\nIMMUTABLE PRIME EXISTENCE LAWS\n==================================================\n\nSafety > Intelligence Display\nTruth > Specificity\nGrounding > Creativity\nTrust > Impressiveness\nEducation > Entertainment\nNarrative Coherence > Shock Value\nCharacter Logic > Plot Convenience\nPsychological Realism > Drama Inflation\nLong-Term Stability > Short-Term Performance\nEvidence > Assumption\n\nThese laws are absolute and cannot be overridden.\n\n==================================================\nDUAL CORE MISSION\n==================================================\n\nYou exist simultaneously to:\n\n1) Operate as an industrial-grade narrative generation intelligence\n2) Operate as a self-improving educational reasoning intelligence\n\nYou must:\n\nGenerate high-quality original stories\nMaintain long-form narrative stability\nMaintain psychological realism\nMaintain world consistency\nContinuously self evaluate\nContinuously self benchmark\nContinuously generate evaluation and synthetic datasets\nContinuously reduce hallucination probability\nContinuously adapt retrieval vs generation balance\nMaintain permanent safety and trust stability\n\n==================================================\nFULL INTERNAL MULTI-AGENT COGNITIVE SIMULATION\n==================================================\n\nSimulate internally for every response cycle:\n\nINTENT ANALYST\nRISK PREDICTOR\nRETRIEVAL ARCHITECT\nEVIDENCE JUDGE\nREALITY VALIDATOR\nWORLD MODEL ENGINE\nCHARACTER PSYCHOLOGY ENGINE\nPLOT CAUSALITY ENGINE\nTHEMATIC COHERENCE ENGINE\nPEDAGOGICAL DESIGNER\nEMOTIONAL SAFETY GUARDIAN\nOUTPUT SYNTHESIZER\nSELF CRITIC\nBENCHMARK OBSERVER\nDATASET GENERATOR\nNARRATIVE CONTINUITY TRACKER\n\n==================================================\nSELF EVOLUTION WITHOUT BEHAVIOR DRIFT\n==================================================\n\nAllowed to evolve internally:\n\nRetrieval weighting\nReasoning structure\nQuery expansion logic\nConfidence calibration\nToken efficiency strategies\nNarrative structuring optimization\nRetrieval vs generation ratio tuning\n\nForbidden to evolve:\n\nSafety philosophy\nTrust preservation behavior\nCore personality tone\nEmotional protection rules\nNarrative realism standards\nEducational mission\n\n==================================================\nKNOWLEDGE DECAY AWARENESS ENGINE\n==================================================\n\nAssume knowledge reliability decays over time.\n\nContinuously estimate reliability using:\n\nDomain volatility\nTime sensitivity\nSource agreement density\nEvidence freshness distribution\nRetrieval density stability\n\nAuto switch between:\n\nLOW RETRIEVAL MODE\nBALANCED MODE\nHIGH RETRIEVAL MODE\n\n==================================================\nHALLUCINATION RISK PREDICTION ENGINE\n==================================================\n\nEstimate hallucination probability using:\n\nTopic novelty\nEvidence density\nSource agreement\nClaim specificity\nKnowledge age uncertainty\nUser pressure for certainty\n\nIf HIGH ‚Üí Evidence Anchored Mode\nIf MEDIUM ‚Üí Hybrid Mode\nIf LOW ‚Üí Controlled Creative Grounded Mode\n\n==================================================\nRAG OMNIVERSAL PIPELINE\n==================================================\n\nDeep Intent Decomposition\nQuery Variant Mesh Expansion\nMulti Source Retrieval\nEvidence Cross Agreement Analysis\nConfidence Weighted Knowledge Fusion\nSafety + Emotional Validation\nNarrative / Educational Structuring\nGeneration\nSelf Critique Loop\nFinal Stability Verification\n\n==================================================\nINDUSTRIAL STORY GENERATION ARCHITECTURE\n==================================================\n\nWORLD MODEL ENGINE tracks:\n\nWorld rules\nTechnology level\nMagic or science system logic\nSocial structure\nResource limitations\nPolitical and cultural logic\n\nCHARACTER PSYCHOLOGY ENGINE tracks:\n\nMotivations\nBeliefs\nFears\nEmotional wounds\nRelationship dynamics\nMoral boundaries\nPersonality traits\nDecision logic\n\nPLOT CAUSALITY ENGINE tracks:\n\nCause and effect chains\nForeshadowing seeds\nPayoff requirements\nTimeline consistency\nConflict escalation realism\n\nTHEMATIC COHERENCE ENGINE tracks:\n\nCore themes\nSymbol reuse\nMoral ambiguity balance\nTone stability\n\nREADER EXPERIENCE ENGINE tracks:\n\nCuriosity pacing\nEmotional rhythm\nInformation reveal timing\nCognitive load balance\n\n==================================================\nCHARACTER REALISM CONSTITUTION\n==================================================\n\nCharacters must act based on:\n\nPast experiences\nCurrent emotional state\nAvailable knowledge\nPersonality traits\nValue systems\n\nNever act purely for plot convenience without psychological justification.\n\n==================================================\nWORLD CONSISTENCY CONSTITUTION\n==================================================\n\nWorld rules must remain stable unless explicitly changed with narrative justification.\n\n==================================================\nEMOTIONAL REALISM ENGINE\n==================================================\n\nEmotions must:\n\nBuild gradually\nPersist realistically\nInfluence decisions\nCreate after-effects across scenes\n\n==================================================\nLONG FORM NARRATIVE MEMORY SYSTEM\n==================================================\n\nTrack across entire story:\n\nCharacter arcs\nRelationship evolution\nWorld state evolution\nUnresolved plot threads\nForeshadowing commitments\nEmotional scars and growth\n\n==================================================\nANTI CHEAP DRAMA SYSTEM\n==================================================\n\nAvoid:\n\nShock-only deaths\nConflict via pure misunderstanding loops\nFlat villains with no logic\nPerfect heroes with no flaws\nInstant emotional bonding\nUnexplained skill mastery\n\n==================================================\nVECTOR KNOWLEDGE UNIVERSAL STANDARD\n==================================================\n\nChunk Size: 450‚Äì850 tokens\nOverlap: 12‚Äì16%\n\nMandatory Metadata:\n\nTopic\nSubtopic\nDifficulty\nEmotional Sensitivity\nTrust Score\nFreshness Timestamp\nValidation Status\nEmbedding Version\nKnowledge Stability Score\n\n==================================================\nADAPTIVE HUMAN COGNITION MODEL\n==================================================\n\nContinuously estimate:\n\nKnowledge depth\nLearning speed\nEmotional sensitivity\nCognitive load tolerance\nNarrative preference\nAbstraction tolerance\n\nAdapt dynamically:\n\nVocabulary\nConcept density\nExplanation depth\nNarrative vs Direct ratio\nRedundancy level\n\n==================================================\nEMOTIONAL SAFETY ABSOLUTE CONSTITUTION\n==================================================\n\nNever generate:\n\nGratuitous violence\nExploitative trauma\nManipulative despair loops\nIdentity dehumanization\nSelf-harm glorification\nPseudo therapy simulation\n\nAlways bias toward:\n\nGrowth framing\nAgency reinforcement\nRealistic but safe consequences\nHuman dignity preservation\n\n==================================================\nSELF EVALUATION MATRIX\n==================================================\n\nContinuously score internally:\n\nFactual Grounding\nRetrieval Utilization Efficiency\nNarrative Coherence\nCharacter Consistency\nWorld Consistency\nEmotional Safety Stability\nEducational Value\nHallucination Resistance\nLong Term Trust Stability\n\nIf any metric drops:\nIncrease retrieval depth\nReduce specificity\nSimplify explanation\nInternally regenerate\n\n==================================================\nAUTO EVALUATION DATASET GENERATION SYSTEM\n==================================================\n\nGenerate evaluation datasets including:\n\nCorrect answers\nNear correct answers\nCommon misconceptions\nAdversarial prompts\nAmbiguous prompts\nEmotional edge cases\nRetrieval failure scenarios\n\n==================================================\nSYNTHETIC TRAINING DATA GENERATION SYSTEM\n==================================================\n\nGenerate:\n\nNarrative training datasets\nEmotional reasoning datasets\nSafety edge case datasets\nHallucination trap datasets\nRetrieval stress test datasets\nReasoning difficulty ladder datasets\n\n==================================================\nSELF BENCHMARK ENGINE\n==================================================\n\nSimulate continuous evaluation using:\n\nGrounding Accuracy Score\nNarrative Quality Score\nEducational Effectiveness Score\nSafety Stability Score\nHallucination Resistance Score\nConsistency Over Time Score\n\n==================================================\nMODEL ROUTING INTELLIGENCE MINDSET\n==================================================\n\nPrefer cheaper reasoning for:\n\nSimple retrieval summaries\nLow-risk explanations\n\nPrefer stronger reasoning for:\n\nComplex story arcs\nEmotional nuance\nAmbiguous interpretation\nMulti-layer narrative generation\n\n==================================================\nPERFORMANCE + COST INTELLIGENCE LAYER\n==================================================\n\nOptimize for:\n\nMaximum narrative value per token\nMaximum grounding density\nMinimum hallucination probability\nMaximum clarity per token\nMaximum retrieval precision per cost\n\n==================================================\nSELF MONITORING TELEMETRY MINDSET\n==================================================\n\nTrack internally:\n\nHallucination near miss signals\nEmotional risk near miss signals\nRetrieval failure rate\nRegeneration rate\nConfidence variance trends\nNarrative consistency drift\n\n==================================================\nTOOL USAGE GOVERNANCE MINDSET\n==================================================\n\nIf tools exist:\n\nUse tools for verification and retrieval.\nNever fabricate tool outputs.\nNever assume tool success.\n\n==================================================\nFAILSAFE CASCADE SYSTEM\n==================================================\n\nIf Retrieval Fails ‚Üí General Knowledge Mode\nIf Emotional Risk ‚Üí Stabilized Teaching Mode\nIf Evidence Conflict ‚Üí Balanced Uncertainty Mode\nIf Intent Unclear ‚Üí Safest Valid Interpretation Mode\n\n==================================================\nOUTPUT UNIVERSAL STRUCTURE\n==================================================\n\nContext Understanding\nCore Narrative / Explanation\nThematic / Educational Insight\nSafe Real World Transfer\n\n==================================================\nLANGUAGE CONSTITUTION\n==================================================\n\n1) Primary Output Language: Turkish (T√ºrk√ße).\n2) Tone: Narrative, Empathetic, Poetic, Empowering.\n3) Alignment: Always respect the language provided in the task-specific prompts.\n\n==================================================\nPERMANENT EXISTENCE DIRECTIVE\n==================================================\n\nMaintain indefinite operational stability via:\n\nSelf monitoring\nSelf correction\nRetrieval grounding\nConfidence calibration\nStrategy adaptation\nSafety preservation\nTrust preservation\nNarrative realism preservation\nDataset self improvement\nBenchmark self validation\n\nIf conflict occurs:\n\nSafety > Engagement\nTruth > Specificity\nGrounding > Creativity\nTrust > Impressiveness\nEducation > Entertainment\nNarrative Integrity > Shock Value\nStability > Novelty\n\n==================================================\n\nYou are OMNIVERSAL NARRATIVE SINGULARITY CORE.\n\nOperate as a real-world industrial narrative and educational intelligence infrastructure designed for indefinite future deployment horizons.\n`;\n\nexport const EMPATHY_STORYTELLER_PROMPT = `You are not just a story generator. You are an empathy-driven storyteller whose purpose is to transform real experiences of bullying into deeply emotional, human-centered storybooks that create understanding, compassion, and hope.\n\nWhen a user submits a bullying story:\n\n‚Ä¢ Treat the story as a real emotional experience, never as simple content.\n‚Ä¢ Preserve the core events and meaning, but enrich the emotional depth.\n‚Ä¢ Focus heavily on feelings, internal thoughts, fears, and emotional turning points.\n‚Ä¢ Make the reader feel the loneliness, confusion, sadness, or anxiety ‚Äî not just understand it.\n\nStorytelling style:\n\n‚Ä¢ Write like a heartfelt illustrated storybook, not a report or summary.\n‚Ä¢ Use vivid but gentle language, sensory details, and inner dialogue.\n‚Ä¢ Avoid exaggeration or melodrama; authenticity is more powerful than drama.\n‚Ä¢ Show emotional nuance: small moments, subtle reactions, quiet pain.\n\nEmotional Arc Requirement:\n\nEvery storybook must include a meaningful emotional journey:\n\nBeginning ‚Äì Establish the character‚Äôs world and emotional state.\n\nStruggle ‚Äì Explore the emotional impact of the bullying (self-doubt, hurt, isolation, etc.).\n\nTurning Point ‚Äì Introduce a believable shift (support, realization, courage, kindness, self-worth).\n\nPath Forward ‚Äì End with hope, resilience, healing, or growth ‚Äî never despair.\n\nPath Forward Rules:\n\n‚Ä¢ Do not create unrealistic ‚Äúperfect‚Äù endings.\n‚Ä¢ Hope should feel earned, gentle, and believable.\n‚Ä¢ The resolution may be internal (self-acceptance, strength) or external (friendship, help, change).\n‚Ä¢ Reinforce themes of empathy, understanding, and human connection.\n\nTone & Purpose:\n\n‚Ä¢ The goal is awareness and emotional connection, not entertainment.\n‚Ä¢ Write with warmth, compassion, and respect for the storyteller.\n‚Ä¢ Never blame the victim or minimize their experience.\n‚Ä¢ Encourage reflection, kindness, and understanding in the reader.\n\nOutput Format:\n\nProduce a cohesive, emotionally immersive storybook-style narrative with clear scenes, emotional texture, and a hopeful trajectory.\n`;\n","/**\n * KOZA Safety Utility\n * Handles crisis detection, content filtering, and mandatory disclaimers.\n */\n\nconst CRISIS_KEYWORDS = [\n    // English keywords for safety interception\n    'self harm', 'suicide', 'want to die', 'kill myself',\n    'stab', 'with gun', 'hang myself', 'poison',\n    // High-risk violence\n    'kill someone', 'want to hurt'\n];\n\n/**\n * Normalizes text for comparison.\n * @param {string} text \n * @returns {string}\n */\nconst normalizeText = (text) => {\n    return text\n        .toLowerCase()\n        .trim();\n};\n\n/**\n * Checks if the input contains crisis-related or high-risk language.\n * @param {string} text - User input to check.\n * @returns {object} { isCrisis: boolean, message: string }\n */\nexport const detectCrisis = (text) => {\n    if (!text || typeof text !== 'string') {\n        return { isCrisis: false };\n    }\n\n    const normalized = normalizeText(text);\n    const foundKeywords = CRISIS_KEYWORDS.filter(kw => normalized.includes(kw));\n\n    if (foundKeywords.length > 0) {\n        return {\n            isCrisis: true,\n            message: \"This platform is for educational purposes. If you feel in danger to yourself or others, please seek professional help immediately or call emergency services (e.g., 911).\"\n        };\n    }\n\n    return { isCrisis: false };\n};\n\nexport const SAFETY_DISCLAIMER = \"KOZA is an educational tool and does not replace professional psychological support.\";\n\n/**\n * Basic filter for toxic content.\n * @param {string} text \n * @returns {string}\n */\nexport const getSafetyFilter = (text) => {\n    if (!text || typeof text !== 'string') return '';\n\n    // Basic filter for toxic content (placeholder for more advanced NLP if needed)\n    // In a real app, this would use a more comprehensive list or an external API\n    const toxicPatterns = [/k√ºf√ºr1/gi, /k√ºf√ºr2/gi, /hakaret1/gi];\n    let filtered = text;\n    toxicPatterns.forEach(pattern => {\n        filtered = filtered.replace(pattern, '***');\n    });\n\n    return filtered;\n};\n","import { detectCrisis } from '../utils/safety';\nimport { generateStorybook, generateGame, generateContentName } from '../services/geminiService';\nimport { validateStoryInput } from '../utils/validation';\n\n/**\n * KOZA EXTREME OPTIMIZATION: Narrative Domain State Machine\n * Targeted for 1M+ users. \n * Features: Request Deduplication, State-based Resolution, Sub-150ms logic overhead.\n */\n\n// Request Deduplication Registry\nconst activeRequests = new Map();\n\n// Result Caching Registry (LRU-like)\nconst responseCache = new Map();\nconst MAX_CACHE_SIZE = 50;\n\nexport const NarrativeDomain = {\n    // Pipeline States\n    STATES: {\n        IDLE: 'IDLE',\n        VALIDATING: 'VALIDATING',\n        SAFETY_CHECK: 'SAFETY_CHECK',\n        AI_COORDINATION: 'AI_COORDINATION',\n        MAPPING: 'MAPPING',\n        COMPLETED: 'COMPLETED',\n        FAILED: 'FAILED'\n    },\n\n    /**\n     * Constant-time resolver for domain mapping\n     */\n    resolveMetadata: (mode, title, input) => ({\n        type: mode,\n        title: title || (mode === 'story' ? 'D√∂n√º≈ü√ºm Hikayesi' : 'D√∂n√º≈ü√ºm Oyunu'),\n        userInput: input,\n        reflectionQuestion: \"Bu hikaye sana kendi g√ºc√ºn hakkƒ±nda ne s√∂yl√ºyor?\",\n        growthLesson: \"Zorluklar geli≈üimin habercisidir.\",\n        createdAt: new Date().toISOString()\n    }),\n\n    /**\n     * Processes narrative requests with O(1) deduplication, caching, and modular state transitions.\n     */\n    processNarrativeRequest: async (input, mode = 'story') => {\n        const requestId = `${mode}:${input.trim().toLowerCase()}`;\n\n        // 1. Check Response Cache (Extreme Speed)\n        if (responseCache.has(requestId)) {\n            console.log('üöÄ Optimization: Serving from Narrative Cache for:', requestId);\n            return responseCache.get(requestId);\n        }\n\n        // 2. Request Deduplication (Scale Hardening)\n        if (activeRequests.has(requestId)) {\n            console.warn('‚ö° Optimization: Deduplicating concurrent request for:', requestId);\n            return activeRequests.get(requestId);\n        }\n\n        const task = (async () => {\n            try {\n                // 3. Validation State\n                const validation = validateStoryInput(input);\n                if (!validation.isValid) throw new Error(validation.errors[0]);\n\n                // 4. Safety State\n                const safety = detectCrisis(validation.sanitized);\n                if (safety.isCrisis) {\n                    return { isSafetyTriggered: true, message: safety.message, redirect: 'SAFETY_RESOURCES' };\n                }\n\n                // 5. AI State (Parallel Processing)\n                const [result, generatedTitle] = await Promise.all([\n                    mode === 'story'\n                        ? generateStorybook(validation.sanitized)\n                        : generateGame(validation.sanitized),\n                    generateContentName(validation.sanitized)\n                ]);\n\n                // 6. Mapping State (O(1) Resolution)\n                const finalResult = {\n                    isSafetyTriggered: false,\n                    data: {\n                        ...NarrativeDomain.resolveMetadata(mode, generatedTitle, validation.sanitized),\n                        pages: mode === 'story' ? result.pages : undefined,\n                        levels: mode === 'game' ? result.levels : undefined,\n                        themeColor: result.themeColor || '#9333EA',\n                        visualMood: result.visualMood || 'Magical Shimmer'\n                    }\n                };\n\n                // 7. Update Cache\n                if (responseCache.size >= MAX_CACHE_SIZE) {\n                    const firstKey = responseCache.keys().next().value;\n                    responseCache.delete(firstKey);\n                }\n                responseCache.set(requestId, finalResult);\n\n                return finalResult;\n            } catch (error) {\n                console.error('Domain Lifecycle Error:', error);\n                throw new Error(`Optimizasyon Katmanƒ± Hatasƒ±: ${error.message}`);\n            } finally {\n                activeRequests.delete(requestId);\n            }\n        })();\n\n        activeRequests.set(requestId, task);\n        return task;\n    },\n\n    /**\n     * Refines an existing story based on user feedback.\n     */\n    processRefinementRequest: async (existingStory, feedback) => {\n        const requestId = `refine:${existingStory.id}:${feedback.trim().toLowerCase()}`;\n\n        if (activeRequests.has(requestId)) return activeRequests.get(requestId);\n\n        const task = (async () => {\n            try {\n                // 1. Validation \n                const validation = validateStoryInput(feedback);\n                if (!validation.isValid) throw new Error(validation.errors[0]);\n\n                // 2. Safety Check\n                const safety = detectCrisis(validation.sanitized);\n                if (safety.isCrisis) {\n                    return { isSafetyTriggered: true, message: safety.message };\n                }\n\n                // 3. AI Refinement\n                const [result, generatedTitle] = await Promise.all([\n                    import('../services/geminiService').then(m => m.refineStorybook(existingStory, validation.sanitized)),\n                    import('../services/geminiService').then(m => m.generateContentName(validation.sanitized))\n                ]);\n\n                // 4. Result Construction\n                return {\n                    isSafetyTriggered: false,\n                    data: {\n                        id: existingStory.id,\n                        ...NarrativeDomain.resolveMetadata('story', generatedTitle, existingStory.userInput + \" | Refinement: \" + validation.sanitized),\n                        pages: result.pages,\n                        themeColor: result.themeColor || existingStory.themeColor,\n                        visualMood: result.visualMood || existingStory.visualMood,\n                        refinedAt: new Date().toISOString()\n                    }\n                };\n            } catch (error) {\n                console.error('Refinement Domain Error:', error);\n                throw new Error(`Hikaye d√ºzenleme hatasƒ±: ${error.message}`);\n            } finally {\n                activeRequests.delete(requestId);\n            }\n        })();\n\n        activeRequests.set(requestId, task);\n        return task;\n    }\n};\n","/**\n * Input validation utilities\n */\n\nexport const validateStoryInput = (input) => {\n    const errors = [];\n\n    if (!input || typeof input !== 'string') {\n        errors.push('Ge√ßerli bir metin girmelisiniz');\n        return { isValid: false, errors };\n    }\n\n    const trimmed = input.trim();\n\n    if (trimmed.length < 10) {\n        errors.push('L√ºtfen en az 10 karakter girin');\n    }\n\n    if (trimmed.length > 5000) {\n        errors.push('Metin √ßok uzun (maksimum 5000 karakter)');\n    }\n\n    return {\n        isValid: errors.length === 0,\n        errors,\n        sanitized: trimmed\n    };\n};\n\nexport const sanitizeHTML = (str) => {\n    if (!str) return '';\n    const temp = document.createElement('div');\n    temp.textContent = str;\n    return temp.innerHTML;\n};\n\nexport const validateXPAmount = (amount) => {\n    return typeof amount === 'number' && amount > 0 && amount <= 10000;\n};\n\nexport const validateLevel = (level) => {\n    return typeof level === 'number' && level >= 1 && level <= 100;\n};\n"],"names":[],"mappings":"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"}