generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @unique @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  // Mastodon Identity Fields
  mastodonUserId       String?   @unique @map("mastodon_user_id") @db.VarChar(255)
  mastodonUsername     String?   @map("mastodon_username") @db.VarChar(255)
  mastodonInstanceUrl  String?   @map("mastodon_instance_url") @db.VarChar(255)

  // Encrypted Tokens (AES-256-GCM)
  mastodonAccessToken    String?   @map("mastodon_access_token") @db.Text
  mastodonRefreshToken   String?   @map("mastodon_refresh_token") @db.Text
  mastodonTokenExpiresAt DateTime? @map("mastodon_token_expires_at") @db.Timestamptz()
  // Encrypted auto-generated password for admin-provisioned accounts
  mastodonPassword       String?   @map("mastodon_password") @db.Text

  syncState  MastodonSyncState?
  failedJobs FailedPublishJob[]
  posts      KozaPost[]

  @@map("users")
}

model MastodonSyncState {
  userId             String    @id @map("user_id") @db.Uuid
  lastNotificationId String?   @map("last_notification_id") @db.VarChar(255)
  lastSyncedAt       DateTime? @map("last_synced_at") @db.Timestamptz()
  syncStatus         String?   @default("idle") @map("sync_status") @db.VarChar(50)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mastodon_sync_states")
}

model FailedPublishJob {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  payload     Json?    @db.JsonB
  errorReason String?  @map("error_reason") @db.Text
  failedAt    DateTime @default(now()) @map("failed_at") @db.Timestamptz()

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("failed_publish_jobs")
}

/// Normalized cache of Mastodon statuses shown in the KOZA Community feed.
model KozaPost {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mastodonStatusId String    @unique @map("mastodon_status_id") @db.VarChar(255)
  userId           String?   @map("user_id") @db.Uuid
  content          String?   @db.Text
  visibility       String?   @db.VarChar(50)
  mediaUrls        Json?     @map("media_urls") @db.JsonB
  likesCount       Int       @default(0) @map("likes_count")
  boostsCount      Int       @default(0) @map("boosts_count")
  repliesCount     Int       @default(0) @map("replies_count")
  authorUsername   String?   @map("author_username") @db.VarChar(255)
  authorAvatarUrl  String?   @map("author_avatar_url") @db.Text
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  syncedAt         DateTime  @default(now()) @map("synced_at") @db.Timestamptz()

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt(sort: Desc)])
  @@map("koza_posts")
}
